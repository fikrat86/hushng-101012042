############################################
# Minimal Cloud Build config to resolve
# unmarshalling error. Once this succeeds,
# we can reintroduce options gradually.
############################################

steps:
  - name: gcr.io/cloud-builders/docker
    id: build
    args:
      [
        'build',
        '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/hushng-101012042/app:${SHORT_SHA}',
        '.'
      ]

  - name: gcr.io/cloud-builders/docker
    id: push
    args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/hushng-101012042/app:${SHORT_SHA}']

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: deploy
    entrypoint: gcloud
    args:
      [
        'run','deploy','hushng-101012042-service',
        '--image','us-central1-docker.pkg.dev/$PROJECT_ID/hushng-101012042/app:${SHORT_SHA}',
        '--region','us-central1',
        '--platform','managed',
        '--allow-unauthenticated'
      ]

images:
  - 'us-central1-docker.pkg.dev/$PROJECT_ID/hushng-101012042/app:${SHORT_SHA}'

timeout: '900s'